<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exploring methods to create a multivariate t-distributed random matrix • mvrt</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Exploring methods to create a multivariate t-distributed random matrix">
<meta property="og:description" content="mvrt">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mvrt</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/mvrt.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/pegeler/mvrt/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Exploring methods to create a multivariate t-distributed random matrix</h1>
                        <h4 class="author">Paul W. Egeler, MS, GStat</h4>
            
            <h4 class="date">2020-10-06</h4>
      
      <small class="dont-index">Source: <a href="http://github.com/pegeler/mvrt/blob/master/vignettes/mvrt.Rmd"><code>vignettes/mvrt.Rmd</code></a></small>
      <div class="hidden name"><code>mvrt.Rmd</code></div>

    </div>

    
    
<p><em>This document is part of the the <a href="https://github.com/pegeler/mvrt/"><code>mvrt</code> package</a>. See the <a href="https://github.com/pegeler/mvrt/blob/master/README.md">README.md</a> for more information on download and installation.</em></p>
<div id="objective" class="section level2">
<h2 class="hasAnchor">
<a href="#objective" class="anchor"></a>Objective</h2>
<p>The objective of this R package vignette is to investigate the various ways of creating multivariate normal/t distributions. An algorithm using Cholesky decomposition is used; first in R code, then in C++ code. This is compared to existing methods for creating multivariate random matrices, such as <code><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">MASS::mvrnorm</a></code> and <code><a href="https://rdrr.io/pkg/mvtnorm/man/Mvt.html">mvtnorm::rmvt</a></code>.</p>
<p>The matrices are compared using summary statistics and graphics (histograms). The distributions are assessed for “believability”. Methods are also explored for ensuring that the specified correlation/covariance structure is preserved, despite the random process of number generation. Finally, benchmarking is perfromed to determine performance differences.</p>
</div>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<div id="defining-the-data" class="section level3">
<h3 class="hasAnchor">
<a href="#defining-the-data" class="anchor"></a>Defining the data</h3>
<p>We will specify the sample n pairs, means, correlation matrix, and variances. The correlation matrix and variances will be used to generate a covariance matrix, which will be used by the random number generator.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw">n</span> <span class="op">&lt;-</span> <span class="fl">30</span>
<span class="kw">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">5</span>,<span class="fl">4</span>)
<span class="kw">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">.9</span>,<span class="fl">.9</span>,<span class="fl">1</span>),<span class="fl">2</span>,<span class="fl">2</span>)
<span class="kw">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.5</span>,<span class="fl">2</span>)

<span class="kw">S</span> <span class="op">&lt;-</span> <span class="kw">mvrt</span>::<span class="fu"><a href="../reference/convert_R2S.html">convert_R2S</a></span>(<span class="kw">R</span>, <span class="kw">var</span>)
</pre></div>
</div>
<div id="defining-the-multivariate-t-distributed-random-matrix-generator-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#defining-the-multivariate-t-distributed-random-matrix-generator-functions" class="anchor"></a>Defining the multivariate t-distributed random matrix generator functions</h3>
<p>First we will define the random number generator functions in R. We will compare the performance of R code with- and without <code class="sourceCode r"><span class="cf">for</span></code> loops. Well-optimized R code may be sufficiently performant as to not warrant the implementation of a compiled alternative.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co"># With a for loop</span>
<span class="kw">mvrt_R_a</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>, <span class="kw">df</span> = <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>) {

  <span class="kw">g.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/chol.html">chol</a></span>(<span class="kw">S</span>))

  <span class="kw">bivMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>,nrow = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">mu</span>), ncol = <span class="kw">n</span>)

  <span class="co">for</span> (<span class="kw">i</span> <span class="co">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="kw">n</span>)) {
    <span class="kw">bivMat</span>[,<span class="kw">i</span>] <span class="op">&lt;-</span> <span class="kw">mu</span> <span class="op">+</span> <span class="kw">g.t</span> <span class="op">%*%</span> <span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">rt</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">mu</span>), <span class="kw">df</span>)
  }

  <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">bivMat</span>)

}

<span class="co"># Without a for loop</span>
<span class="kw">mvrt_R_b</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>, <span class="kw">df</span> = <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>) {
  
  <span class="kw">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chol.html">chol</a></span>(<span class="kw">S</span>)
  
  <span class="kw">random_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">rt</a></span>(<span class="kw">n</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">mu</span>), <span class="kw">df</span>),nrow = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">mu</span>))
  <span class="kw">deviation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">g</span>) <span class="op">%*%</span> <span class="kw">random_matrix</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">mu</span> <span class="op">+</span> <span class="kw">deviation</span>)
  
}
</pre></div>
</div>
<div id="compiling-and-loading-the-c-mvrt-random-matrix-generator" class="section level3">
<h3 class="hasAnchor">
<a href="#compiling-and-loading-the-c-mvrt-random-matrix-generator" class="anchor"></a>Compiling and loading the C++ mvrt random matrix generator</h3>
<p>Next we will load in a function written in C++. The expectation is that the C++ code will be faster than the R code, possibly by several orders of magnitude.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw">Rcpp</span>::<span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">sourceCpp</a></span>(<span class="st">"../src/mvrt.cpp"</span>)
</pre></div>
<p>The code that was loaded is below.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">using namespace Rcpp;</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">//' @rdname mvrt</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">//' @export</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">// [[Rcpp::export]]</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9">arma::mat mvrt(<span class="dt">int</span> n, arma::vec mu, arma::mat S, <span class="dt">int</span> df=<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">{</a>
<a class="sourceLine" id="cb4-11" data-line-number="11"></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">  <span class="co">// Cholesky decomp and transpose covariance matrix</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">  arma::mat g = chol(S).t();</a>
<a class="sourceLine" id="cb4-14" data-line-number="14"></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">  <span class="co">// Generate the random data</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">  <span class="dt">auto</span> x_vec = rt(mu.size() * n, df);</a>
<a class="sourceLine" id="cb4-17" data-line-number="17">  arma::mat x = arma::mat(&amp;x_vec[<span class="dv">0</span>], mu.size(), n, false, true);</a>
<a class="sourceLine" id="cb4-18" data-line-number="18"></a>
<a class="sourceLine" id="cb4-19" data-line-number="19">  <span class="co">// Give the random data covariance structure and add mean offset</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20">  x = g * x;</a>
<a class="sourceLine" id="cb4-21" data-line-number="21">  x.each_col() += mu;</a>
<a class="sourceLine" id="cb4-22" data-line-number="22"></a>
<a class="sourceLine" id="cb4-23" data-line-number="23">  <span class="cf">return</span> x.t();</a>
<a class="sourceLine" id="cb4-24" data-line-number="24">}</a></code></pre></div>
</div>
<div id="define-our-function-for-getting-a-distribution-of-correlation-coefficients" class="section level3">
<h3 class="hasAnchor">
<a href="#define-our-function-for-getting-a-distribution-of-correlation-coefficients" class="anchor"></a>Define our function for getting a distribution of correlation coefficients</h3>
<p>This function will take a function and its arguments and run it a specified number of times, performing a correlation on the output and extracting the off-diagonal element. Essentially, we can use this to run each random number generator an arbitrary number of times and get the Pearson’s correlation for each pair of vectors created. This can be used to examine the distribution of correlation coefficients that can be expected from the random generation processes. Note the random seed parameter which can be set for reproducibility.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw">get_cor_dist</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">FUN</span>, <span class="kw">times</span>, <span class="kw">...</span>, <span class="kw">seed</span> = <span class="fl">999</span>) {
  
  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="kw">seed</span>)
  
  <span class="kw">FUN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.fun.html">match.fun</a></span>(<span class="kw">FUN</span>)
  
  <span class="kw">my_call</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/call.html">as.call</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">FUN</span>, <span class="kw">...</span>))
  
  <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>(<span class="kw">times</span>)
  
  <span class="co">for</span> (<span class="kw">i</span> <span class="co">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="kw">times</span>)) {
    
    <span class="kw">out</span>[<span class="kw">i</span>] <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="kw">my_call</span>))[<span class="fl">2</span>]
    
  }
  
  <span class="kw">out</span>
  
}
</pre></div>
</div>
<div id="generating-the-distributions-of-correlation-coeffiencts-using-sever-random-matrix-generators" class="section level3">
<h3 class="hasAnchor">
<a href="#generating-the-distributions-of-correlation-coeffiencts-using-sever-random-matrix-generators" class="anchor"></a>Generating the distributions of correlation coeffiencts using sever random matrix generators</h3>
<p>Using the function above, we will create similar multivariate t-distributed (or normally-distributed) random matrices using several functions.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="kw">mvrtRa_dist</span> <span class="op">&lt;-</span>  <span class="fu">get_cor_dist</span>(<span class="kw">mvrt_R_a</span>, <span class="fl">100</span>, <span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>)
<span class="kw">mvrtRb_dist</span> <span class="op">&lt;-</span>  <span class="fu">get_cor_dist</span>(<span class="kw">mvrt_R_b</span>, <span class="fl">100</span>, <span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>)
<span class="kw">mvrt_dist</span> <span class="op">&lt;-</span>    <span class="fu">get_cor_dist</span>(<span class="kw">mvrt</span>, <span class="fl">100</span>, <span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>, <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>)  
<span class="kw">MASS_dist</span> <span class="op">&lt;-</span>    <span class="fu">get_cor_dist</span>(<span class="kw">MASS</span>::<span class="kw"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span>, <span class="fl">100</span>, <span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>)
<span class="kw">mvtnorm_dist</span> <span class="op">&lt;-</span> <span class="fu">get_cor_dist</span>(<span class="kw">mvtnorm</span>::<span class="kw"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvt.html">rmvt</a></span>, <span class="fl">100</span>, <span class="kw">n</span>, <span class="kw">S</span>, <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>)
</pre></div>
</div>
</div>
<div id="analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#analysis" class="anchor"></a>Analysis</h2>
<div id="checking-the-algorithm" class="section level3">
<h3 class="hasAnchor">
<a href="#checking-the-algorithm" class="anchor"></a>Checking the algorithm</h3>
<div id="homogenous-outputs" class="section level4">
<h4 class="hasAnchor">
<a href="#homogenous-outputs" class="anchor"></a>Homogenous outputs</h4>
<p>First let’s check that our three home-grown functions produce identical results.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="kw">mvrtRa_dist</span>, <span class="kw">mvrt_dist</span>) <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="kw">mvrtRb_dist</span>, <span class="kw">mvrt_dist</span>)) {
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Distributions of correlation coefficients are identical"</span>)
} <span class="co">else</span> {
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Distributions of correlation coefficients are NOT identical"</span>)
}
</pre></div>
<pre><code>## Distributions of correlation coefficients are NOT identical</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="co">if</span> (
  <span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(
    (<span class="kw">mvrt_sample</span> <span class="op">&lt;-</span> {<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">999</span>); <span class="fu"><a href="../reference/mvrt.html">mvrt</a></span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>, <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>)}),
    {<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">999</span>); <span class="fu">mvrt_R_a</span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>)}
    ) <span class="op">&amp;&amp;</span>
  <span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(
    <span class="kw">mvrt_sample</span>,
    {<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">999</span>); <span class="fu">mvrt_R_b</span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>)}
    )
) {
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Random samples generated match"</span>)
} <span class="co">else</span> {
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Random samples generated do NOT match"</span>)
}
</pre></div>
<pre><code>## Random samples generated do NOT match</code></pre>
<p>It appears that we are successful in that the three functions produce identical output. Therefore, we must only examine one function’s output when doing distribution analysis, rather than all three.</p>
</div>
<div id="inspecting-outputted-means-and-variances" class="section level4">
<h4 class="hasAnchor">
<a href="#inspecting-outputted-means-and-variances" class="anchor"></a>Inspecting outputted means and variances</h4>
<p>Let’s run a couple of checks to make sure that the algorithm is at least giving us data with approximately correct means and variances.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="co"># Mean mu</span>
<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">30</span>,<span class="fl">100</span>), <span class="kw">mvrt</span>, <span class="kw">mu</span>, <span class="kw">S</span>, <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>),<span class="kw">colMeans</span>)))
</pre></div>
<pre><code>## [1] 4.943320 3.951612</code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="co"># Mean var</span>
<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">30</span>,<span class="fl">100</span>), <span class="kw">mvrt</span>, <span class="kw">mu</span>, <span class="kw">S</span>, <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>), <span class="kw">apply</span>, <span class="fl">2</span>, <span class="kw">var</span>)))
</pre></div>
<pre><code>## [1] 2.607499 2.103790</code></pre>
<p>Means are close and variances are just a little higher than those specified in the covariance matrix, which we might expect from a relatively small sample size.</p>
</div>
<div id="an-individual-sample" class="section level4">
<h4 class="hasAnchor">
<a href="#an-individual-sample" class="anchor"></a>An individual sample</h4>
<p>Let’s pull a single sample of n = 30. We can check the mean, variance, and correlation.</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="kw">mvrt_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvrt.html">mvrt</a></span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>, <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>)

<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span>(<span class="kw">mvrt_sample</span>)
</pre></div>
<pre><code>## [1] 5.261327 4.106697</code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="kw">mvrt_sample</span>, <span class="fl">2</span>,<span class="kw">var</span>)
</pre></div>
<pre><code>## [1] 2.157964 1.204207</code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(<span class="kw">mvrt_sample</span>)
</pre></div>
<pre><code>##           [,1]      [,2]
## [1,] 1.0000000 0.8381404
## [2,] 0.8381404 1.0000000</code></pre>
<p>How does a plot of the data look?</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span>(<span class="kw">mvrt_sample</span>)
<span class="co"># Regression line</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="kw">mvrt_sample</span>[,<span class="fl">2</span>] <span class="op">~</span> <span class="kw">mvrt_sample</span>[,<span class="fl">1</span>]), col = <span class="st">"red"</span>)

<span class="co"># Center of points</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw">mvrt_sample</span>[,<span class="fl">1</span>]), <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw">mvrt_sample</span>[,<span class="fl">2</span>]), col = <span class="st">"blue"</span>, pch = <span class="fl">22</span>)
</pre></div>
<p><img src="mvrt_files/figure-html/unnamed-chunk-11-1.png" width="576" style="display: block; margin: auto;"></p>
<p>OK. So we are fairly confident that we are getting the data we requested. Now let’s look at how the correlation coefficients are distributed over several simulations.</p>
</div>
</div>
<div id="comparing-the-correlation-coefficient-distributions-of-the-various-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#comparing-the-correlation-coefficient-distributions-of-the-various-functions" class="anchor"></a>Comparing the correlation coefficient distributions of the various functions</h3>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="co"># Summary of the distributions</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw">mvrt_dist</span>)
</pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.7809  0.8804  0.9084  0.9043  0.9316  0.9588</code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw">MASS_dist</span>)
</pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.7500  0.8831  0.9082  0.9010  0.9219  0.9661</code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw">mvtnorm_dist</span>)
</pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.7777  0.8816  0.9030  0.8980  0.9251  0.9570</code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="co"># Graphical representations</span>
<span class="kw">my_hist</span> <span class="op">&lt;-</span> <span class="fu">function</span> (<span class="kw">data</span>) {
  <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(
    <span class="kw">data</span>, 
    xlim = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span>), 
    breaks = <span class="st">"fd"</span>, 
    main = <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Histogram of"</span>,<span class="fu"><a href="https://rdrr.io/r/base/deparse.html">deparse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="kw">data</span>))),
    xlab = <span class="fu"><a href="https://rdrr.io/r/base/deparse.html">deparse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/substitute.html">substitute</a></span>(<span class="kw">data</span>))
  )
  
  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(v = <span class="fl">0.9</span>, col = <span class="st">'red'</span>)
}

<span class="fu">my_hist</span>(<span class="kw">mvrt_dist</span>)
</pre></div>
<p><img src="mvrt_files/figure-html/unnamed-chunk-12-1.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb29"><pre class="downlit">
<span class="fu">my_hist</span>(<span class="kw">MASS_dist</span>)
</pre></div>
<p><img src="mvrt_files/figure-html/unnamed-chunk-12-2.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="fu">my_hist</span>(<span class="kw">mvtnorm_dist</span>)
</pre></div>
<p><img src="mvrt_files/figure-html/unnamed-chunk-12-3.png" width="576" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="guaranteeing-outputs-are-within-a-specified-range" class="section level2">
<h2 class="hasAnchor">
<a href="#guaranteeing-outputs-are-within-a-specified-range" class="anchor"></a>Guaranteeing outputs are within a specified range</h2>
<p>What if we would like to specify that the matrix of values returned is within a reasonable margin to the specified correlation coefficient? This can be done through iterative generation of the random sample with acceptance checks at each step. A matrix norm of the difference in correlation matrices (between generated and specified) may be used as an intuitive check. We may specify that the maximum modulus of the difference between specified and returned correlation matrix elements is below a given threshold.</p>
<p>The determinant may also be used (and is potentially faster). However the norm may be more easily interpreted since the element-wise maximum modulus is a good way for the user to specify an acceptance criterion.</p>
<div id="choosing-the-matrix-norm-over-the-determinant" class="section level3">
<h3 class="hasAnchor">
<a href="#choosing-the-matrix-norm-over-the-determinant" class="anchor"></a>Choosing the matrix norm over the determinant</h3>
<p>Why use the matrix norm rather than the determinant or some other measure? Because it is the most intuitive. The matrix norm is computed several ways. We will use the maximum modulus (absolute value) method, which is equivalent to performing <code class="sourceCode r"><span class="kw">max</span>(<span class="kw">abs</span>())</code> on a matrix. This means that in we can specify the maximum devation of any element within the resultant correlation matrix generated by random sample versus the specified. For example, specifying a maximum matrix norm of 0.05 means that the Pearson’s correlation generated from outputted values will be within <span class="math inline">\(\pm\)</span> 0.05 of the Pearson’s correlation used as the input correlation matrix (as derived form the input covariance matrix).</p>
<p>To demonstrate, we will create a reference correlation matrix and then compare it to a set of contender matrices using the determinant and norm.</p>
<div class="sourceCode" id="cb31"><pre class="downlit">
<span class="co"># A single reference matrix</span>
<span class="kw">R_ref</span> <span class="op">&lt;-</span> <span class="kw">mvrt</span>::<span class="fu"><a href="../reference/make_cor_mat.html">make_cor_mat</a></span>(<span class="fl">.9</span>)
<span class="kw">R_ref</span>
</pre></div>
<pre><code>##      [,1] [,2]
## [1,]  1.0  0.9
## [2,]  0.9  1.0</code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit">
<span class="co"># A set of test matrices</span>
<span class="kw">R_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">.5</span>,<span class="fl">1</span>,<span class="fl">.05</span>), <span class="kw">mvrt</span>::<span class="kw"><a href="../reference/make_cor_mat.html">make_cor_mat</a></span>)
<span class="kw">R_test</span>[[<span class="fl">1</span>]]
</pre></div>
<pre><code>##      [,1] [,2]
## [1,]  1.0  0.5
## [2,]  0.5  1.0</code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit">
<span class="co"># What does the determinant look like for the difference matrices?</span>
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="kw">R_test</span>, <span class="fu">function</span>(<span class="kw">a</span>,<span class="kw">b</span>) <span class="fu"><a href="https://rdrr.io/r/base/det.html">det</a></span>(<span class="kw">a</span> <span class="op">-</span> <span class="kw">b</span>), <span class="kw">R_ref</span>)
</pre></div>
<pre><code>##  [1] -0.1600 -0.1225 -0.0900 -0.0625 -0.0400 -0.0225 -0.0100 -0.0025  0.0000
## [10] -0.0025 -0.0100</code></pre>
<div class="sourceCode" id="cb37"><pre class="downlit">
<span class="co"># And the matrix norm?</span>
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="kw">R_test</span>, <span class="fu">function</span>(<span class="kw">a</span>,<span class="kw">b</span>) <span class="fu"><a href="https://rdrr.io/r/base/norm.html">norm</a></span>(<span class="kw">a</span> <span class="op">-</span> <span class="kw">b</span>, <span class="st">"m"</span>), <span class="kw">R_ref</span>)
</pre></div>
<pre><code>##  [1] 0.40 0.35 0.30 0.25 0.20 0.15 0.10 0.05 0.00 0.05 0.10</code></pre>
<p>The user is more likely to understand how to specify a max norm than a max determinant.</p>
</div>
<div id="iterative-function-definitions" class="section level3">
<h3 class="hasAnchor">
<a href="#iterative-function-definitions" class="anchor"></a>Iterative function definitions</h3>
<p>Below we see two function definitions which perform the same task but implement different programming techniques. The first utilizes recursive function calls, while the second uses a <code class="sourceCode r"><span class="cf">for</span></code> loop to repeat sample generation until the acceptance criterion is met.</p>
<div class="sourceCode" id="cb39"><pre class="downlit">
<span class="co"># Using recursive function calls</span>
<span class="kw">mvrt_R_c</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>, <span class="kw">df</span> = <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>, <span class="kw">max.norm</span> = <span class="fl">0.05</span>, <span class="kw">type.norm</span> = <span class="st">"m"</span>) {
 
  <span class="kw">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chol.html">chol</a></span>(<span class="kw">S</span>)
 
  <span class="kw">random_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">rt</a></span>(<span class="kw">n</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">mu</span>), <span class="kw">df</span>),nrow = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">mu</span>))
  <span class="kw">deviation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">g</span>) <span class="op">%*%</span> <span class="kw">random_matrix</span>
 
  <span class="kw">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">mu</span> <span class="op">+</span> <span class="kw">deviation</span>)
 
  <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/norm.html">norm</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov2cor</a></span>(<span class="kw">S</span>) <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(<span class="kw">out</span>), type = <span class="kw">type.norm</span>) <span class="op">&lt;=</span> <span class="kw">max.norm</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">out</span>)
  } <span class="co">else</span> {
    <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/match.call.html">match.call</a></span>())
  }
 
}


<span class="co"># Using the for loop</span>
<span class="kw">mvrt_R_d</span> <span class="op">&lt;-</span> <span class="fu">function</span>(
  <span class="kw">n</span>,
  <span class="kw">mu</span>,
  <span class="kw">S</span>,
  <span class="kw">df</span> = <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>,
  <span class="kw">max_norm</span> = <span class="fl">0.05</span>,
  <span class="kw">max_iterations</span> = <span class="fl">1000</span>,
  <span class="kw">type_norm</span> = <span class="st">"m"</span>)
{

  <span class="kw">g.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/chol.html">chol</a></span>(<span class="kw">S</span>))

  <span class="kw">R_ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov2cor</a></span>(<span class="kw">S</span>)

  <span class="co">for</span> (<span class="kw">iterations</span> <span class="co">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="kw">max_iterations</span>)) {

    <span class="kw">random_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">rt</a></span>(<span class="kw">n</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">mu</span>), <span class="kw">df</span>),nrow = <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">mu</span>))
    <span class="kw">deviation</span> <span class="op">&lt;-</span> <span class="kw">g.t</span> <span class="op">%*%</span> <span class="kw">random_matrix</span>

    <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/norm.html">norm</a></span>(<span class="kw">R_ref</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">mu</span> <span class="op">+</span> <span class="kw">deviation</span>)), type = <span class="kw">type_norm</span>) <span class="op">&lt;=</span> <span class="kw">max_norm</span>)
      <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="kw">mu</span> <span class="op">+</span> <span class="kw">deviation</span>))

  }

  <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>(
    <span class="st">"Correlation structure with max norm of "</span>, <span class="kw">max_norm</span>,
    <span class="st">" was not obtained in "</span>, <span class="kw">max_iterations</span>, <span class="st">" iterations"</span>
    )

}
</pre></div>
<p>We may also include a <code>C++</code> function to achieve this.</p>
<div class="sourceCode" id="cb40"><pre class="downlit">
<span class="kw">Rcpp</span>::<span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">sourceCpp</a></span>(<span class="st">"../src/mvrt2.cpp"</span>)
</pre></div>
<p>The code that was loaded is below.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode c"><code class="sourceCode c"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="pp">#include </span><span class="im">&lt;RcppArmadillo.h&gt;</span></a>
<a class="sourceLine" id="cb41-2" data-line-number="2"><span class="co">// [[Rcpp::depends(RcppArmadillo)]]</span></a>
<a class="sourceLine" id="cb41-3" data-line-number="3"></a>
<a class="sourceLine" id="cb41-4" data-line-number="4">using namespace Rcpp;</a>
<a class="sourceLine" id="cb41-5" data-line-number="5"></a>
<a class="sourceLine" id="cb41-6" data-line-number="6"><span class="co">//' @rdname mvrt</span></a>
<a class="sourceLine" id="cb41-7" data-line-number="7"><span class="co">//' @export</span></a>
<a class="sourceLine" id="cb41-8" data-line-number="8"><span class="co">// [[Rcpp::export]]</span></a>
<a class="sourceLine" id="cb41-9" data-line-number="9">arma::mat mvrt2(</a>
<a class="sourceLine" id="cb41-10" data-line-number="10">    <span class="dt">int</span> n,</a>
<a class="sourceLine" id="cb41-11" data-line-number="11">    arma::vec mu,</a>
<a class="sourceLine" id="cb41-12" data-line-number="12">    arma::mat S,</a>
<a class="sourceLine" id="cb41-13" data-line-number="13">    <span class="dt">int</span> df=<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb41-14" data-line-number="14">    <span class="dt">double</span> max_norm=<span class="dv">2</span>,</a>
<a class="sourceLine" id="cb41-15" data-line-number="15">    <span class="dt">int</span> max_iterations=<span class="dv">1000</span></a>
<a class="sourceLine" id="cb41-16" data-line-number="16">  )</a>
<a class="sourceLine" id="cb41-17" data-line-number="17">{</a>
<a class="sourceLine" id="cb41-18" data-line-number="18"></a>
<a class="sourceLine" id="cb41-19" data-line-number="19">  <span class="co">// Cholesky decomp and transpose covariance matrix</span></a>
<a class="sourceLine" id="cb41-20" data-line-number="20">  arma::mat g = chol(S).t();</a>
<a class="sourceLine" id="cb41-21" data-line-number="21"></a>
<a class="sourceLine" id="cb41-22" data-line-number="22">  <span class="co">// Get correlation matrix of user-input S matrix</span></a>
<a class="sourceLine" id="cb41-23" data-line-number="23">  arma::mat V_sqrt_inv = diagmat(<span class="dv">1</span> / sqrt(S.diag()));</a>
<a class="sourceLine" id="cb41-24" data-line-number="24">  arma::mat target_cor = V_sqrt_inv * S * V_sqrt_inv;</a>
<a class="sourceLine" id="cb41-25" data-line-number="25"></a>
<a class="sourceLine" id="cb41-26" data-line-number="26">  <span class="cf">for</span> (<span class="dt">int</span> iteration=<span class="dv">0</span>; iteration &lt; max_iterations; iteration++) {</a>
<a class="sourceLine" id="cb41-27" data-line-number="27"></a>
<a class="sourceLine" id="cb41-28" data-line-number="28">    <span class="co">// Generate the random data</span></a>
<a class="sourceLine" id="cb41-29" data-line-number="29">    <span class="dt">auto</span> x_vec = rt(mu.size() * n, df);</a>
<a class="sourceLine" id="cb41-30" data-line-number="30">    arma::mat x = arma::mat(&amp;x_vec[<span class="dv">0</span>], mu.size(), n, false, true);</a>
<a class="sourceLine" id="cb41-31" data-line-number="31"></a>
<a class="sourceLine" id="cb41-32" data-line-number="32">    <span class="co">// Give the random data covariance structure and add mean offset</span></a>
<a class="sourceLine" id="cb41-33" data-line-number="33">    x = g * x;</a>
<a class="sourceLine" id="cb41-34" data-line-number="34">    x.each_col() += mu;</a>
<a class="sourceLine" id="cb41-35" data-line-number="35"></a>
<a class="sourceLine" id="cb41-36" data-line-number="36">    <span class="co">// Compare to target and retrun if meets specification</span></a>
<a class="sourceLine" id="cb41-37" data-line-number="37">    arma::mat diff_matrix = abs(cor(x.t()) - target_cor);</a>
<a class="sourceLine" id="cb41-38" data-line-number="38"></a>
<a class="sourceLine" id="cb41-39" data-line-number="39">    <span class="cf">if</span> (diff_matrix.max() &lt;= max_norm)</a>
<a class="sourceLine" id="cb41-40" data-line-number="40">      <span class="cf">return</span> x.t();</a>
<a class="sourceLine" id="cb41-41" data-line-number="41">  }</a>
<a class="sourceLine" id="cb41-42" data-line-number="42"></a>
<a class="sourceLine" id="cb41-43" data-line-number="43">  stop(</a>
<a class="sourceLine" id="cb41-44" data-line-number="44">    <span class="st">"Did not generate matrix with max norm of %f in %i iterations"</span>,</a>
<a class="sourceLine" id="cb41-45" data-line-number="45">    max_norm,</a>
<a class="sourceLine" id="cb41-46" data-line-number="46">    max_iterations</a>
<a class="sourceLine" id="cb41-47" data-line-number="47">  );</a>
<a class="sourceLine" id="cb41-48" data-line-number="48"></a>
<a class="sourceLine" id="cb41-49" data-line-number="49">}</a></code></pre></div>
</div>
<div id="checking-our-work" class="section level3">
<h3 class="hasAnchor">
<a href="#checking-our-work" class="anchor"></a>Checking our work</h3>
<p>Now lets see if the distributions tighten up with our new functions. We should now see that the correlation coefficient of each of our randomly generated samples will not stray more than 0.05 from the correlation of the correlation matrix used to specify the covariance structure of the data.</p>
<div class="sourceCode" id="cb42"><pre class="downlit">
<span class="kw">mvrtRc_dist</span> <span class="op">&lt;-</span>  <span class="fu">get_cor_dist</span>(<span class="kw">mvrt_R_c</span>, <span class="fl">100</span>, <span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>)
<span class="kw">mvrtRd_dist</span> <span class="op">&lt;-</span>  <span class="fu">get_cor_dist</span>(<span class="kw">mvrt_R_d</span>, <span class="fl">100</span>, <span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>)
<span class="kw">mvrt2_dist</span> <span class="op">&lt;-</span>   <span class="fu">get_cor_dist</span>(<span class="kw">mvrt2</span>,    <span class="fl">100</span>, <span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>, <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0.05</span>)

<span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="kw">mvrtRc_dist</span>, <span class="kw">mvrtRd_dist</span>) <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="kw">mvrtRc_dist</span>, <span class="kw">mvrt2_dist</span>)) {
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Distributions of correlation coefficients are identical"</span>)
} <span class="co">else</span> {
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span>(<span class="st">"Distributions of correlation coefficients are NOT identical"</span>)
}
</pre></div>
<pre><code>## Distributions of correlation coefficients are identical</code></pre>
<div class="sourceCode" id="cb44"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw">mvrtRc_dist</span>)
</pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.8545  0.8801  0.9070  0.9028  0.9257  0.9472</code></pre>
<div class="sourceCode" id="cb46"><pre class="downlit">
<span class="fu">my_hist</span>(<span class="kw">mvrtRc_dist</span>)
</pre></div>
<p><img src="mvrt_files/figure-html/unnamed-chunk-17-1.png" width="576" style="display: block; margin: auto;"></p>
<p>This appears to have worked. Compare with distributions explored in the previous section.</p>
<p>We can also specify a different covariance structure and check again. This demonstrates the usage of the various function definitions we have created for this exercise.</p>
<div class="sourceCode" id="cb47"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(
  <span class="fu">get_cor_dist</span>(
    <span class="kw">mvrt_R_d</span>, 
    <span class="fl">100</span>, 
    <span class="kw">n</span>, 
    <span class="kw">mu</span>, 
    <span class="kw">mvrt</span>::<span class="fu"><a href="../reference/convert_R2S.html">convert_R2S</a></span>(<span class="kw">mvrt</span>::<span class="fu"><a href="../reference/make_cor_mat.html">make_cor_mat</a></span>(<span class="fl">0.2</span>),<span class="kw">var</span>)
    )
  )
</pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.1502  0.1727  0.2059  0.2012  0.2254  0.2500</code></pre>
<p>Not surprisingly, the correlation coefficients remain within [0.15,0.25].</p>
</div>
</div>
<div id="benchmarking" class="section level2">
<h2 class="hasAnchor">
<a href="#benchmarking" class="anchor"></a>Benchmarking</h2>
<p>Let’s see how the functions compare in speed.</p>
<div class="sourceCode" id="cb49"><pre class="downlit">
<span class="kw">microbenchmark</span>::<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span>(
  <span class="co"># No data checks</span>
  <span class="fu">mvrt_R_a</span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>),               <span class="co"># 'for' loop</span>
  <span class="fu">mvrt_R_b</span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>),               <span class="co"># Optimized R code</span>
  <span class="fu"><a href="../reference/mvrt.html">mvrt</a></span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>, <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>),            <span class="co"># C++ code</span>
  
  <span class="co"># Iterative checking</span>
  <span class="fu">mvrt_R_c</span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>),               <span class="co"># Recursive call</span>
  <span class="fu">mvrt_R_d</span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>),               <span class="co"># 'for' loop</span>
  <span class="fu"><a href="../reference/mvrt.html">mvrt2</a></span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>, <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">0.05</span>),     <span class="co"># C++ code</span>
  
  <span class="co"># Available packages on CRAN</span>
  <span class="kw">MASS</span>::<span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>),
  <span class="kw">mvtnorm</span>::<span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvt.html">rmvt</a></span>(<span class="kw">n</span>, <span class="kw">S</span>, <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>) <span class="op">+</span> <span class="kw">mu</span>
)
</pre></div>
<pre><code>## Unit: microseconds
##                             expr     min       lq      mean   median       uq
##               mvrt_R_a(n, mu, S)  90.661 108.4645 121.40708 116.6335 124.3230
##               mvrt_R_b(n, mu, S)  20.899  25.0180  30.97702  27.5790  32.1935
##            mvrt(n, mu, S, n - 1)   8.147  11.3415  14.22796  12.7420  14.0440
##               mvrt_R_c(n, mu, S)  47.564  58.7980  87.52966  65.3965  92.3645
##               mvrt_R_d(n, mu, S)  55.022  64.5345  79.60625  72.3330  86.4830
##     mvrt2(n, mu, S, n - 1, 0.05)   9.584  13.9980  19.26501  15.2845  20.9425
##          MASS::mvrnorm(n, mu, S)  57.528  69.0395  77.12211  72.7785  80.7545
##  mvtnorm::rmvt(n, S, n - 1) + mu 222.389 242.6085 264.10592 250.9265 266.4525
##      max neval
##  210.871   100
##   81.664   100
##   36.124   100
##  389.618   100
##  179.257   100
##   90.935   100
##  177.896   100
##  489.337   100</code></pre>
<p>I know the <code class="sourceCode r"><span class="op">::</span></code> operator has a performance cost for those CRAN packages. It may be interesting to try the benchmarking with loaded packages, too.</p>
<div class="sourceCode" id="cb51"><pre class="downlit">
<span class="kw">MASS_mvrnorm</span> <span class="op">&lt;-</span> <span class="kw">MASS</span>::<span class="kw"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span>
<span class="kw">mvtnorm_rmvt</span> <span class="op">&lt;-</span> <span class="kw">mvtnorm</span>::<span class="kw"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvt.html">rmvt</a></span>

<span class="kw">microbenchmark</span>::<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span>(
  <span class="kw">MASS</span>::<span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>),
  <span class="fu">MASS_mvrnorm</span>(<span class="kw">n</span>, <span class="kw">mu</span>, <span class="kw">S</span>),
  <span class="kw">mvtnorm</span>::<span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvt.html">rmvt</a></span>(<span class="kw">n</span>, <span class="kw">S</span>, <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>) <span class="op">+</span> <span class="kw">mu</span>,
  <span class="fu">mvtnorm_rmvt</span>(<span class="kw">n</span>, <span class="kw">S</span>, <span class="kw">n</span> <span class="op">-</span> <span class="fl">1</span>) <span class="op">+</span> <span class="kw">mu</span>
)
</pre></div>
<pre><code>## Unit: microseconds
##                             expr     min       lq      mean   median      uq
##          MASS::mvrnorm(n, mu, S)  52.782  59.6945  67.07632  64.7465  69.097
##           MASS_mvrnorm(n, mu, S)  45.846  52.4620  60.08722  57.8490  60.704
##  mvtnorm::rmvt(n, S, n - 1) + mu 212.948 222.8000 252.81270 230.5440 244.164
##   mvtnorm_rmvt(n, S, n - 1) + mu 202.570 214.8225 230.15693 220.5860 236.567
##       max neval
##   140.642   100
##   152.106   100
##  1619.700   100
##   435.766   100</code></pre>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>Clearly, rolling your own C++ code is superior. But given the performance gain from removing the <code class="sourceCode r"><span class="cf">for</span></code> loop from our original R function, optimization of R code cannot be underestimated. Given that the well-written R code is comparably performant within an order of magnitude, the switch to C++ is likely not worth the additional effort in this case.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Paul Egeler.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
